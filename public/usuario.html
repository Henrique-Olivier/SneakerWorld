<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Perfil</title>
    <link rel="stylesheet" href="./css/usuario.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="shortcut icon" type="imagex/png" href="../assets/imgs/internet.png">
    <script src="./js/sessao.js"></script>
</head>





<body onload="CarregarDados()">
    <div class="sideBar">
        <div class="user">
            <img src="./assets/imgs/usuario.png" alt="">
            <div>
                <p id="p_nome">Henrique</p>
                <p id="p_sobrenome">Olivier</p>
            </div>
        </div>
        <div class="userData">
            <h2>Seus Dados:</h2>
            <div>
                <h6>E-mail</h6>
                <p id="email">Henrique@email.com</p>
            </div>
        </div>
        <div class="favoriteBrand" id="favoriteBrand">
            <h2>Marca Favorita:</h2>
        </div>
        <button onclick="limparSessao()">Sair</button>
    </div>
    <div class="screen">
        <div class="FavoriteData">
            <div class="FavoriteConter">
                <h1>Contador Marcas</h1>
                <div class="BrandBox">
                    <div class="nike">
                        <h2>Nike</h2>
                        <h1 id="contador_nike">0</h1>
                        <p>usuarios</p>
                    </div>
                    <div class="adidas">
                        <h2>Adidas</h2>
                        <h1 id="contador_adidas">0</h1>
                        <p>usuarios</p>
                    </div>
                    <div class="vans">
                        <h2>Vans</h2>
                        <h1 id="contador_vans">0</h1>
                        <p>usuarios</p>
                    </div>
                    <div class="puma">
                        <h2>Puma</h2>
                        <h1 id="contador_puma">0</h1>
                        <p>usuarios</p>
                    </div>
                    <div class="ous">
                        <h2>Ous</h2>
                        <h1 id="contador_ous">0</h1>
                        <p>usuarios</p>
                    </div>
                </div>
            </div>
            <div class="FavoriteChart">
                <canvas id="myChart"></canvas>
            </div>
        </div>
        <div class="memorygameContainer">
            <div class="memoryGame">
                <main>
                    <header>
                        <span>Movimentos: <span class="moves">00</span></span>
                        <span>Tempo: <span class="timer">00</span></span>
                    </header>
                    <div class="container">
                        <h1>Jogo da Memoria</h1>
                        <div class="grid">
                        </div>
                        <button onclick="ButtonStart()" id="ButtonStart">Iniciar</button>
                    </div>
                </main>
            </div>
            <div class="kpiMemorygame">
                <div class="record">
                    <div class="timeRecord">
                        <h1>Seu record de<br> movimentos é:</h1>
                        <p id="inserir_record_movimentos"></p>
                    </div>
                    <div class="movesRecord">
                        <h1>Seu record de<br> tempo é:</h1>
                        <p id="inserir_record_tempo"></p>
                    </div>
                    <div class="gameRecord">
                        <h1>Seu melhor jogo foi:</h1>
                    </div>
                </div>
                <div class="ranking">
                    <h1>Ranking <br> jogo da memória:</h1>
                    <div class="rankingGrid" id="rankingGrid">
                        <!-- <div class="rankingPosition">
                            <div class="positionNumber">
                                <p>1º</p>
                            </div>
                            <div class="playerName">
                                <p>Henrique</p>
                            </div>
                            <div class="playerMoves">
                                <p>00</p>
                            </div>
                            <div class="playerTime">
                                <P>00</P>
                            </div>
                        </div>
                        <div class="rankingPosition">
                            <div class="positionNumber">
                                <p>2º</p>
                            </div>
                            <div class="playerName">
                                <p>Henrique</p>
                            </div>
                            <div class="playerMoves">
                                <p>00</p>
                            </div>
                            <div class="playerTime">
                                <P>00</P>
                            </div> -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>
</body>

</html>

<script>
    const grid = document.querySelector('.grid');
    const spanPlayer = document.querySelector('.player')
    const timer = document.querySelector('.timer')
    const moves = document.querySelector('.moves')
    const StartButton = document.querySelector('#ButtonStart')

    const CardElements = [
        'img-1',
        'img-2',
        'img-3',
        'img-4',
        'img-5',
        'img-6',
        'img-7',
        'img-8',
    ]

    const createElement = (tag, className) => {
        const element = document.createElement(tag);
        element.className = className;
        return element;
    }

    let FirstCard = '';
    let SecondCard = '';
    let movesCount = 0

    const checkEndGame = () => {
        const disabledCards = document.querySelectorAll('.disable-card');

        if (disabledCards.length === 16) {
            const idVar = sessionStorage.ID_USUARIO;
            const tempoVar = timer.innerHTML;
            clearInterval(this.loop);

            alert(`Parabéns! Seu tempo foi: ${tempoVar} segundos, com ${movesCount} Movimentos.`);

            fetch('/avisos/publicar', {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify({
                    tempoServer: tempoVar,
                    movimentosServer: movesCount
                })
            }).then(resposta => {
                if (resposta.ok) {
                    return resposta.json();
                } else if (resposta.status === 404) {
                    window.alert("Deu 404!");
                    return null;
                } else {
                    throw new Error("Houve um erro ao tentar realizar a postagem! Código da resposta: " + resposta.status);
                }
            }).then(data => {
                if (data) {
                    let idRegistro = data.insertId
                    let idUsuario = sessionStorage.getItem('ID_USUARIO')
                    // window.alert("Realizado Cadastro memory game");

                    fetch(`/avisos/cadastrarRanking`, {
                        method: "post",
                        headers: {
                            "Content-Type": "application/json"
                        },
                        body: JSON.stringify({
                            idRegistroServer: idRegistro,
                            idUsuarioServer: idUsuario
                        })
                    }).then(function (resposta) {

                        console.log("resposta: ", resposta);

                        if (resposta.ok) {
                            // window.alert("ranking cad");
                            window.location.reload(true)
                        } else if (resposta.status == 404) {
                            window.alert("Deu 404!");
                        } else {
                            throw ("erro ranking" + resposta.status);
                        }
                    }).catch(function (resposta) {
                        console.log(`#ERRO: ${resposta}`);
                        // finalizarAguardar();
                    });

                    return false;

                }
            }).catch(erro => {
                console.error(`#ERRO: ${erro}`);
            });

            return false;
        }
    }


    const checkCards = () => {
        const firstElement = FirstCard.getAttribute('data-element')
        const secondElement = SecondCard.getAttribute('data-element')

        if (firstElement == secondElement) {
            FirstCard.firstChild.classList.add('disable-card')
            SecondCard.firstChild.classList.add('disable-card')

            FirstCard = '';
            SecondCard = '';


            checkEndGame();
        } else {

            setTimeout(() => {
                FirstCard.classList.remove('reveal-card')
                SecondCard.classList.remove('reveal-card')

                FirstCard = '';
                SecondCard = '';
            }, 500)
        }


    }

    const revealCard = ({ target }) => {

        if (target.parentNode.className.includes('reveal-card')) {
            return;
        }

        if (FirstCard == '') {
            target.parentNode.classList.add('reveal-card');
            FirstCard = target.parentNode
        } else if (SecondCard == '') {
            target.parentNode.classList.add('reveal-card');
            SecondCard = target.parentNode;

            checkCards();
        }

        movesCount += 1
        moves.innerHTML = movesCount
    }


    const CreateCard = (CardElement) => {


        const card = createElement('div', 'card');
        const front = createElement('div', 'face front');
        const back = createElement('div', 'face back');

        front.style.backgroundImage = `url('./assets/imgs/${CardElement}.png')`;

        card.appendChild(front);
        card.appendChild(back);

        card.addEventListener('click', revealCard)
        card.setAttribute('data-element', CardElement)

        return card;
    }

    const LoadGame = () => {

        const DuplicateElements = [...CardElements, ...CardElements];

        const ShuffledArray = DuplicateElements.sort(() => Math.random() - 0.5);

        DuplicateElements.forEach((cardElement) => {

            const card = CreateCard(cardElement)
            grid.appendChild(card)
        });
    }

    const startTimer = () => {

        this.loop = setInterval(() => {

            const currentTime = Number(timer.innerHTML);
            timer.innerHTML = currentTime + 1;

        }, 1000)
    }


    const ButtonStart = () => {

        StartButton.style.display = 'none'

        const playerName = localStorage.getItem('nome');

        // spanPlayer.innerHTML = playerName
        startTimer()
        LoadGame()
    }

    function CarregarDados() {

        let marca = sessionStorage.getItem('MARCAFAVORITA_USUARIO')
        const nome = sessionStorage.getItem('NOME_USUARIO')
        let recordtempo = sessionStorage.getItem('RECORD_TEMPO')
        let recordMovimentos = sessionStorage.getItem('RECORD_MOVIMENTOS')
        let sobrenome = sessionStorage.getItem('SOBRENOME_USUARIO')
        let contadorGeral = sessionStorage.getItem('CONTADORMARCAS')
        const arrayContador = JSON.parse(contadorGeral);

        const addMarca = document.querySelector('#favoriteBrand')
        const addNome = document.querySelector('#p_nome')
        const addSobrenome = document.querySelector('#p_sobrenome')
        const addTempo = document.querySelector('#inserir_record_tempo')
        const addMovimentos = document.querySelector('#inserir_record_movimentos')

        let nike = arrayContador[0].contador
        let adidas = arrayContador[1].contador
        let vans = arrayContador[2].contador
        let puma = arrayContador[3].contador
        let ous = arrayContador[4].contador

        const contadorNike = document.querySelector('#contador_nike')
        const contadorAdidas = document.querySelector('#contador_adidas')
        const contadorVans = document.querySelector('#contador_vans')
        const contadorPuma = document.querySelector('#contador_puma')
        const contadorOus = document.querySelector('#contador_ous')

        contadorNike.innerHTML = nike
        contadorAdidas.innerHTML = adidas
        contadorVans.innerHTML = vans
        contadorPuma.innerHTML = puma
        contadorOus.innerHTML = ous

        addNome.innerHTML = nome
        addSobrenome.innerHTML = sobrenome
        addTempo.innerHTML = recordtempo
        addMovimentos.innerHTML = recordMovimentos



        if (marca == 1) {
            addMarca.innerHTML += `<img src="./assets/imgs/nike.png" alt="">`
        } else if (marca == 2) {
            addMarca.innerHTML += `<img src="./assets/imgs/adidas.png" alt="">`
        } else if (marca == 3) {
            addMarca.innerHTML += `<img src="./assets/imgs/vans.webp" alt="">`
        } else if (marca == 4) {
            addMarca.innerHTML += `<img src="./assets/imgs/puma.png" alt="">`
        } else if (marca == 5) {
            addMarca.innerHTML += `<img src="./assets/imgs/ous.webp" alt="">`
        }

        const ctx = document.getElementById('myChart').getContext('2d');
        ctx.canvas.width = 1000;
        ctx.canvas.height = 0;
        new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Nike', 'Adidas', 'Vans', 'Puma', 'Ous'],
                datasets: [{
                    label: '# of Votes',
                    data: [nike, adidas, vans, puma, ous],
                    backgroundColor: 'rgba(49, 27, 146, 0.5)',
                    borderColor: 'rgba(49, 27, 146, 0.6)',
                    borderWidth: 3
                }]
            },
            options: {
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });

        var ranking = JSON.parse(sessionStorage.RANKING);
        ranking.forEach((item, index) => {
            document.getElementById("rankingGrid").innerHTML += `
        <div class="rankingPosition">
            <div class="positionNumber">
                <p>${index + 1}º</p>
            </div>
            <div class="playerName">
                <p>${item.Nome}</p>
            </div>
            <div class="playerMoves">
                <p>${item.Movimentos}</p>
            </div>
            <div class="playerTime">
                <P>${item.Tempo}</P>
            </div>
        </div>
    `;
        });

    }




</script>